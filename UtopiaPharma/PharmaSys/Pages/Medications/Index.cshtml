@page
@model PharmaSys.Pages.Medications.IndexModel
@{
    ViewData["Title"] = "Médicaments";
}

<div class="d-flex align-items-start justify-content-between mb-3">
    <div>
        <h2 class="fw-bold mb-1">Gestion des Médicaments</h2>
        <div class="text-muted">@Model.Medications.Count produits en stock</div>
    </div>

    <a class="btn btn-primary btn-pill" href="/Medications/Create">
        <i class="bi bi-plus-lg me-2"></i>Ajouter Médicament
    </a>
</div>

@if (!string.IsNullOrWhiteSpace(Model.SuccessMessage))
{
    <div class="alert alert-success">@Model.SuccessMessage</div>
}
@if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
{
    <div class="alert alert-danger">@Model.ErrorMessage</div>
}

<div class="card-soft p-3">
    <div class="d-flex gap-2 mb-3 flex-wrap">
        
        <form method="get" class="d-flex align-items-center gap-2" style="flex:1; min-width:260px;">
            <div class="searchbox d-flex align-items-center gap-2 w-100">
                <i class="bi bi-search text-muted"></i>
                <input name="Q" value="@Model.Q" placeholder="Rechercher par nom, code..." />
                
                @if (Model.CatId.HasValue)
                {
                    <input type="hidden" name="CatId" value="@Model.CatId" />
                }
            </div>
        </form>

        <form method="get" class="d-inline">
            <div class="input-group d-inline-flex" style="width: auto;">
                <span class="input-group-text bg-white border-end-0" style="border-radius: 14px 0 0 14px;">
                    <i class="bi bi-funnel text-muted"></i>
                </span>
                <select name="CatId" class="form-select border-start-0" 
                        style="border-radius: 0 14px 14px 0; min-width: 150px; cursor:pointer;"
                        onchange="this.form.submit()">
                    <option value="">Toutes les catégories</option>
                    @foreach (var c in Model.Categories)
                    {
                        if (Model.CatId == c.Id)
                        {
                            <option value="@c.Id" selected>@c.Name</option>
                        }
                        else
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    }
                </select>
                
                @if (!string.IsNullOrEmpty(Model.Q))
                {
                    <input type="hidden" name="Q" value="@Model.Q" />
                }
            </div>
        </form>

        <form method="post" asp-page-handler="Export" class="d-inline">
            <button type="submit" class="btn btn-light btn-pill">
                <i class="bi bi-download me-2"></i>Exporter
            </button>
        </form>

        <form method="post" asp-page-handler="Import" enctype="multipart/form-data" class="d-inline">
            <label class="btn btn-light btn-pill mb-0" style="cursor:pointer;">
                <i class="bi bi-upload me-2"></i>Importer
                <input type="file" name="CsvFile" accept=".csv" hidden onchange="this.form.submit()" />
            </label>
        </form>

        <form method="post" asp-page-handler="Template" class="d-inline">
            <button type="submit" class="btn btn-outline-secondary btn-pill">
                <i class="bi bi-filetype-csv me-2"></i>Template CSV
            </button>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th>CODE</th>
                    <th>PRODUIT</th>
                    <th>CATÉGORIE</th>
                    <th>STOCK</th>
                    <th>PRIX</th>
                    <th>EXPIRATION</th>
                    <th>EMPL.</th>
                    <th class="text-end">ACTIONS</th>
                </tr>
            </thead>
            <tbody id="medRows">
                @foreach (var m in Model.Medications)
                {
                    <tr>
                        <td class="text-muted">@m.Code</td>
                        <td>
                            <div class="fw-semibold">@m.Name @m.Dosage</div>
                            <div class="text-muted" style="font-size:12px;">@m.Manufacturer</div>
                        </td>
                        <td>
                            <span class="badge-soft" style="background:#eef4ff;color:#2f6df6;">
                                @m.Category?.Name
                            </span>
                        </td>
                        <td>
                            <span class="badge-soft" style="background:#eafff1;color:#16a34a;">
                                @m.Stock unités
                            </span>
                        </td>
                        <td class="fw-semibold">@m.SalePrice.ToString("C")</td>
                        
                        <td class="text-muted">@m.ExpirationDate?.ToString("yyyy-MM-dd")</td>
                        <td class="text-muted">@m.Location</td>
                        <td class="text-end">
                            <a class="btn btn-light btn-pill btn-sm" href="/Medications/Edit?id=@m.Id">
                                <i class="bi bi-pencil"></i>
                            </a>

                            <a class="btn btn-sm btn-light btn-pill" href="/Medications/Delete?id=@m.Id">
                                <i class="bi bi-trash text-danger"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="text-muted mt-2" style="font-size:12px;">
        Import CSV : Code;Name;Dosage;Manufacturer;Barcode;Category;Stock;StockMin;PurchasePrice;SalePrice;ExpiryDate;Location;Supplier
        (Date au format yyyy-MM-dd)
    </div>
</div>

@section Scripts {
    <script>
        const q = document.querySelector('input[name="Q"]');
        if(q) {
            // Focus automatique
            const len = q.value.length;
            q.focus();
            if(len > 0) q.setSelectionRange(len, len);
        }
    </script>
}